<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>ChartFox Token Auto-Generator</title>
</head>
<body style="font-family:Arial;background:#1e1e1e;color:white;padding:40px;">
  <h2>üé´ G√©n√©ration automatique du token ChartFox</h2>
  <p id="status">Initialisation...</p>

<script>
const client_id = "9f946a22-0dc6-4027-a66e-9678e653c478"; // ton ID ChartFox
const redirect_uri = window.location.origin + window.location.pathname;
const scope = "charts:view charts:index charts:files";

async function generateCodeVerifier() {
  const array = new Uint8Array(64);
  window.crypto.getRandomValues(array);
  return btoa(String.fromCharCode(...array))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

async function generateCodeChallenge(codeVerifier) {
  const enc = new TextEncoder();
  const data = enc.encode(codeVerifier);
  const digest = await window.crypto.subtle.digest("SHA-256", data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

function getURLParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

async function login() {
  const codeVerifier = await generateCodeVerifier();
  const codeChallenge = await generateCodeChallenge(codeVerifier);
  localStorage.setItem("code_verifier", codeVerifier);

  const authUrl = `https://api.chartfox.org/oauth/authorize?response_type=code&client_id=${client_id}&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scope)}&code_challenge=${codeChallenge}&code_challenge_method=S256`;

  document.getElementById("status").textContent = "üîÑ Redirection vers ChartFox pour autorisation...";
  window.location = authUrl;
}

async function handleOAuthRedirect() {
  const code = getURLParam("code");
  if (!code) return false;

  const codeVerifier = localStorage.getItem("code_verifier");
  if (!codeVerifier) return false;

  document.getElementById("status").textContent = "üîÅ √âchange du code contre un token...";

  const resp = await fetch("https://api.chartfox.org/oauth/token", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      grant_type: "authorization_code",
      code,
      redirect_uri,
      client_id,
      code_verifier: codeVerifier
    })
  });

  if (!resp.ok) {
    document.getElementById("status").textContent = `‚ùå Erreur ${resp.status}`;
    return false;
  }

  const data = await resp.json();
  if (data.access_token) {
    localStorage.setItem("access_token", data.access_token);
    history.replaceState({}, null, redirect_uri);
    document.getElementById("status").innerHTML = "‚úÖ Token obtenu et enregistr√© dans le cache.<br><br><b>Token :</b><br>" + data.access_token;
    console.log("TOKEN:", data.access_token);
    return true;
  } else {
    document.getElementById("status").textContent = "‚ùå Pas de token re√ßu.";
    return false;
  }
}

(async function init() {
  const token = localStorage.getItem("access_token");

  if (token) {
    document.getElementById("status").innerHTML = "‚úÖ Token d√©j√† enregistr√© dans le cache :<br><br><b>" + token + "</b>";
    console.log("Token trouv√©:", token);
    return;
  }

  const success = await handleOAuthRedirect();
  if (!success) {
    await login(); // d√©marre le flux OAuth
  }
})();
</script>
</body>
</html>
